# 🚨 Failure Response Plan (장애 대응 시나리오)

## 🎯 목적




* 이커머스 시스템에서 고부하 상황 또는 예기치 못한 장애 발생 시 대응 방안을 사전 정의하고, 병목 지점을 식별하여 개선 방안을 수립함.




---

## 📌 1. 장애 발생 가정 시나리오




### 💥 장애 시나리오 A: 이벤트 주문 폭주로 인한 DB 커넥션 부족




* 현상: 주문 API 호출 시 500 에러 빈번 발생
* 원인:

    * 커넥션 풀 부족 (HikariCP의 max pool size 도달)
    * 쿠폰 및 주문 INSERT/UPDATE 쿼리 충돌

> ✅ 대응 방안:
>
> * `hikari.maximum-pool-size` 조정 (예: 10 → 50)
> * 비동기 큐 또는 Kafka 이벤트 처리 방식 적용
> * DB 커넥션 풀 모니터링 활성화

---




### 🧨 장애 시나리오 B: Redis 기반 쿠폰 선착순 발급 시 race condition 발생




* 현상: 동일 쿠폰이 중복 발급됨 / Redis key 충돌 발생
* 원인:

    * Lua 스크립트 또는 분산락 미적용
    * Redis TTL 미설정으로 쿠폰 key 무한 증가

> ✅ 대응 방안:
>
> * Redis Lua 스크립트 또는 Redisson 분산락 적용
> * key TTL 설정하여 GC 유도
> * 쿠폰 발급 처리 전 사용자 발급 여부 사전 검증

---




### 🔥 장애 시나리오 C: 인기상품 실시간 재고 차감 시 재고 음수 발생




* 현상: 재고가 0임에도 주문이 처리됨
* 원인:

    * Redis 차감 처리의 선점 로직 누락
    * DB와의 동기화 타이밍 이슈

> ✅ 대응 방안:
>
> * Redis ZSET 기반 재고 선점 → DB 비동기 반영
> * DB 차감 시 조건절로 재고 0 이상 검증 쿼리 추가 (`UPDATE stock SET qty = qty - 1 WHERE qty > 0`)
> * 초당 TPS 제한 (rate limiting) 도입

---




## ⚙️ 2. 시스템 리소스 조정




### Docker 자원 제한 및 테스트

```bash
$ docker run -m 1g --cpus=1 ...
```

* JVM 메모리 제한 옵션 추가 (예: `-Xmx512m`)
* GC 로그 확인을 통해 Full GC 빈도 확인

---




## 📊 3. 성능 테스트 기반 병목 지표




| 지표           | 기준        | 테스트 결과 예시                          |
| ------------ | --------- | ---------------------------------- |
| 평균 응답속도      | 1.5초 이하   | 2.1초 → 초과 발생 구간 확인 필요              |
| 에러율          | 1% 이하     | 3.5% → 500/쿠폰 충돌 시 집중              |
| TPS (초당 처리량) | 최소 100TPS | 70TPS → scaling or cache tuning 필요 |

---

## ✅ 향후 개선

* Kafka 기반 비동기 이벤트 구조로 변경
* 캐시 TTL 정책 재설계
* MySQL → Read Replication 구조 도입 고려
